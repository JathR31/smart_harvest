<!DOCTYPE html>
<html>
<head>
    <title>Planting Schedule API Test</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
</head>
<body class="bg-gray-100 p-8" x-data="testAPI()">
    <div class="max-w-6xl mx-auto">
        <h1 class="text-3xl font-bold text-green-700 mb-4">Planting Schedule API Test</h1>
        
        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">API Status</h2>
            <div class="space-y-2">
                <div class="flex items-center">
                    <span class="font-medium w-48">Schedule API:</span>
                    <span x-text="scheduleStatus" :class="scheduleStatus === 'Connected' ? 'text-green-600' : 'text-red-600'"></span>
                </div>
                <div class="flex items-center">
                    <span class="font-medium w-48">Optimal API:</span>
                    <span x-text="optimalStatus" :class="optimalStatus === 'Connected' ? 'text-green-600' : 'text-red-600'"></span>
                </div>
                <div class="flex items-center">
                    <span class="font-medium w-48">Municipality:</span>
                    <span x-text="municipality"></span>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">Optimal Planting Recommendation</h2>
            <div class="grid grid-cols-3 gap-4">
                <div>
                    <p class="text-sm text-gray-500">Best Crop</p>
                    <p class="text-2xl font-bold" x-text="optimal.crop"></p>
                </div>
                <div>
                    <p class="text-sm text-gray-500">Expected Yield</p>
                    <p class="text-2xl font-bold" x-text="optimal.expected_yield + ' mt/ha'"></p>
                </div>
                <div>
                    <p class="text-sm text-gray-500">Planting Window</p>
                    <p class="text-2xl font-bold" x-text="optimal.next_date"></p>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow p-6">
            <h2 class="text-xl font-semibold mb-4">Top 5 Crop Recommendations</h2>
            <table class="w-full">
                <thead>
                    <tr class="border-b">
                        <th class="text-left p-2">Crop</th>
                        <th class="text-left p-2">Variety</th>
                        <th class="text-left p-2">Planting</th>
                        <th class="text-left p-2">Harvest</th>
                        <th class="text-left p-2">Yield</th>
                        <th class="text-left p-2">Status</th>
                    </tr>
                </thead>
                <tbody>
                    <template x-for="schedule in schedules" :key="schedule.crop">
                        <tr class="border-b">
                            <td class="p-2 font-medium" x-text="schedule.crop"></td>
                            <td class="p-2" x-text="schedule.variety"></td>
                            <td class="p-2" x-text="schedule.optimal_planting"></td>
                            <td class="p-2" x-text="schedule.expected_harvest"></td>
                            <td class="p-2" x-text="schedule.yield_prediction"></td>
                            <td class="p-2">
                                <span class="px-2 py-1 rounded text-xs" 
                                      :class="schedule.status === 'Recommended' ? 'bg-green-100 text-green-700' : 'bg-blue-100 text-blue-700'"
                                      x-text="schedule.status"></span>
                            </td>
                        </tr>
                    </template>
                    <tr x-show="schedules.length === 0">
                        <td colspan="6" class="p-4 text-center text-gray-500">
                            <span x-text="loading ? 'Loading data...' : 'No data available'"></span>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div class="mt-6 bg-blue-50 border border-blue-200 rounded-lg p-4" x-show="error">
            <h3 class="font-semibold text-blue-900">Error Information:</h3>
            <p class="text-blue-800" x-text="error"></p>
        </div>
    </div>

    <script>
        function testAPI() {
            return {
                municipality: 'La Trinidad',
                scheduleStatus: 'Connecting...',
                optimalStatus: 'Connecting...',
                optimal: {
                    crop: 'Loading...',
                    expected_yield: 0,
                    next_date: 'Loading...'
                },
                schedules: [],
                loading: true,
                error: '',

                async init() {
                    console.log('Initializing API test...');
                    await this.loadOptimal();
                    await this.loadSchedule();
                },

                async loadOptimal() {
                    try {
                        const response = await fetch(`/dashboard/SmartHarvest/public/api/planting/optimal?municipality=${encodeURIComponent(this.municipality)}`);
                        console.log('Optimal API Response:', response.status);
                        
                        if (response.ok) {
                            const data = await response.json();
                            console.log('Optimal Data:', data);
                            this.optimal = data;
                            this.optimalStatus = 'Connected';
                        } else {
                            this.optimalStatus = 'Error: ' + response.status;
                            this.error = `Optimal API returned status ${response.status}`;
                        }
                    } catch (e) {
                        console.error('Optimal API Error:', e);
                        this.optimalStatus = 'Error';
                        this.error = 'Optimal API: ' + e.message;
                    }
                },

                async loadSchedule() {
                    try {
                        const response = await fetch(`/dashboard/SmartHarvest/public/api/planting/schedule?municipality=${encodeURIComponent(this.municipality)}`);
                        console.log('Schedule API Response:', response.status);
                        
                        if (response.ok) {
                            const data = await response.json();
                            console.log('Schedule Data:', data);
                            this.schedules = data;
                            this.scheduleStatus = 'Connected';
                        } else {
                            this.scheduleStatus = 'Error: ' + response.status;
                            this.error = `Schedule API returned status ${response.status}`;
                        }
                    } catch (e) {
                        console.error('Schedule API Error:', e);
                        this.scheduleStatus = 'Error';
                        this.error = 'Schedule API: ' + e.message;
                    } finally {
                        this.loading = false;
                    }
                }
            }
        }
    </script>
</body>
</html>
